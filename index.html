<html><head>
  <meta name="viewport" content="width=640, initial-scale=1">
</head>
<body>
 // <link href="https://bms-tsbt.github.io/configura/TinyDash/tinydash.css" rel="stylesheet">
  <script src="https://bms-tsbt.github.io/configura/TinyDash/tinydash.js"></script>
//  <link href="https://bms-tsbt.github.io/configura/TinyDash/tinydash_editor.css" rel="stylesheet">
  <script src="https://bms-tsbt.github.io/configura/TinyDash/tinydash_editor.js"></script>
  <script src="https://bms-tsbt.github.io/configura/tsbt.js"></script>  
  <script>
    var bank= "TSBT";
    var batt=0;
    var data = [];
   // for (var i=0;i<100;i++) data.push(Math.cos(i/10));
    var o = {
      l:TD.label({x:10,y:10,width:90,height:40,label:"TSBT"}),
      bal:TD.label({x:240,y:10,width:170,height:40,label:"Balanceamento"}),
      le:TD.label({x:110,y:10,width:120,height:40,label:"xxx-yyy"}),
      bk:TD.label({x:10,y:60,width:90,height:40,label:"Banco"}),
      bke:TD.label({x:110,y:60,width:120,height:40,label:bank}),
      bt:TD.label({x:10,y:110,width:90,height:60,label:"Bateria"}),
      //bte:TD.label({x:110,y:110,width:120,height:40,label:batt}),
      //v:TD.gauge({x:220,y:10,width:200,height:210,label:"Tensão 2.5 a 4.5 V",value:"3.25",min:2.5,max:4.5,name:"gaugeV"}),
      vb:TD.value({x:240,y:60,width:170,height:60,label:"tensão",value:"3.6",min:3.0,step:0.05,max:3.9}),
      ib:TD.value({x:240,y:110,width:170,height:60,label:"corrente",value:"200",min:50,step:50,max:600}),
      //bkn:TD.value({x:10,y:230,width:300,height:60,label:"alterar banco",value:"1",min:1,step:1,max:10}),
      btn:TD.value({x:110,y:110,width:120,height:60,label:"",value:"1",min:0,step:1,max:200}),
      ab:TD.toggle({x:240,y:180,width:170,height:90,label:"Desativar <-----------> Ativar",value:1,name:"toggle"}),
      s:TD.button({x:82,y:180,width:65,height:90,label:".Verificar",value:0,name:"buttonS",onChange: writeThings()}),
      b:TD.button({x:10,y:180,width:65,height:90,label:"Localizar",value:0,name:"buttonL",onchange:function(e){try{connection.write('LED1.set();LED2.set();\n');}catch{}}}),
      d:TD.button({x:155,y:180,width:75,height:90,label:"-> Salvar",value:0,name:"buttonD",onchange:function(e){try{writeThings();connection.write('clearInterval(int)\n;');connection.close();document.body.appendChild(o.modal)}catch(e){alert(e);}}}),
      //t:TD.gauge({x:430,y:10,width:200,height:210,label:"Temperatura 0 a 50 ºC",value:25,min:0,max:50,name:"gaugeT"}),
      //gr:TD.graph({x:220,y:220,width:400,height:170,label:"Evolução",data:data}),
      log:TD.log({x:10,y:280,width:400,height:200,label:"Log",text:"conectando"}),
      modal:TD.modal({x:10,y:10,width:400,height:480,label:"Clique para conectar",onchange:connectDevice})
    };
    //o.log.log("Olá");
    
    for (var i in o) document.body.appendChild(o[i]);

    o.le.contentEditable = "true";
    o.bke.contentEditable = "true";
   
//TD.startEditor();
function writeThings (){
  tsbt.eval("prm",(r)=>{
    r.L=o.le.opts.value;
    r.Bkn=bke.opts.value;
    r.Btn=btn.opts.value;
    r.Vb=o.vb.opts.value;
    r.Ibal=o.ib.opts.value;
    r.isBal=o.ab.opts.value;
    });
  tsbt.eval('updatePrmStorage('+r+');\
    local = '+ r.L +' ;\
    bankName= '+ r.Bkn + ';\
    battName = '+ rm.Btn + ';\
    Vbalance = '+ r.Vb + ';\
    Ibalance = ' + r.Ibal + ';\
    isBalancing = ' + r.isBal + ';',
    (rt)=>{return rt}) 
  } 

  prm=require("Storage").readJSON('prm',true)||{};

  TStype=prm.TStype||"TSBT";
  version=prm.Vrs||"1.1.0";
  battName = prm.Btn||NRF.getAddress().slice(-5);

  Vbalance =prm.Vb||3.65;
  Vbalance_min =prm.Vbmin||3.65; 
  offsetV = prm.offsetV||0.0;

  Ibank_max= prm.Ibmax||200;

  
  isCurrentSensorBoard= prm.isSB||false;
 
  Vmax=prm.Vmax||3.9;
  Vmin=prm.Vmin||2.5;
  Tmax=prm.Tmax||50;
  Tmin=prm.Tmin||0;

    
    
function onLine(line) {
//   o.log.log(line);
   try {
     var j = JSON.parse(line.substring(1));
     o.log.log(line);
     (j.TStype!='TSGW'?o.ab.setValue(j.isBal):0);
     (j.TStype!='TSGW'?o.vb.setValue(j.Vb):0);
     (j.TStype!='TSGW'?o.ib.setValue((j.Ibal?j.Ibal:200)):""); 
     (j.TStype!='TSGW'?o.btn.setValue((isNaN(j.Btn)?0:j.Btn)):"");   
     o.l.firstElementChild.innerText=(j.TStype?j.TStype:"TSBT")
   } catch(e) {
     o.log.log(e);
   }
 }
 var connection;
 function connectDevice() {
   tsbt.connect(function(c) {
     if (!c) {
       alert("Desconectado!");
       return;
     }
     connection = c;
     // remove modal window
        o.modal.remove();
     // Handle the data we get back, and call 'onLine'
     // whenever we get a line
     var buf = "";
     connection.on("data", function(d) {
       buf += d;
       var i = buf.indexOf("\n");
       while (i>=0) {
         onLine(buf.substr(0,i));
         buf = buf.substr(i+1);
         i = buf.indexOf("\n");
       }
     });
     // First, reset tsbt.js
     connection.write("LED1.set();\n", function() {
       // Wait for it to reset itself
       o.log.log("Aguarde até 10 segundos");
       setTimeout(function() {
         // Now tell it to write data on the current temperature level to Bluetooth
         // 10 times a second. Also ensure that when disconnected, tsbt.js
         // resets so the setInterval doesn't keep draining battery.
         connection.write("int=setInterval(function(){Bluetooth.println(JSON.stringify({V:getVin(),T:E.getTemperature(),Vb:Vbalance,Bkn:bankName,Btn:battName,L:local,isBal:isBalancing,Ibal:Ibalance,TStype:TStype,Vrs:version}));},2000);NRF.on('disconnect', function() {LED1.reset();clearInterval(int);});\n",
           function() { console.log("Lido..."); });
         }, 1500);
       });
     });

 } 
  </script>

</body></html>

